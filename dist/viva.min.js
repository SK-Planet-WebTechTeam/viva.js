!function(a,b){var c="ontouchstart"in a,d=c?"touchstart":"mousedown",e=c?"touchmove":"mousemove",f=c?"touchend":"mouseup",g=Date.now;a.raf=function(){return a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||function(b){a.setTimeout(b,1e3/60)}}();a.viva={};var h=function(a,b){this.x=a||0,this.y=b||0};h.prototype.add=function(){for(var a=0;a<arguments.length;a++)this.x+=arguments[a].x,this.y+=arguments[a].y;return this},h.prototype.sub=function(){for(var a=0;a<arguments.length;a++)this.x-=arguments[a].x,this.y-=arguments[a].y;return this},h.prototype.scale=function(a){return this.x*=a,this.y*=a,this},h.prototype.dot=function(a){return this.x*a.x+this.y*a.y},h.prototype.cross=function(a){return this.x*a.y-this.y*a.x},h.prototype.mult=function(a){return this.x*=a.x,this.y*=a.y,this},h.prototype.projection=function(a){var b=this.dot(a),c=a.magnitude(),d=viva.vector.copy(a);return d.scale(b/(c*c)),d},h.prototype.angleBetween=function(a){return this.isZero()||a.isZero()?0:Math.acos(this.dot(a)/(this.magnitude()*a.magnitude()))},h.prototype.normalize=function(){return this.scale(1/this.magnitude()),this},h.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},h.prototype.rotate=function(a){var b=Math.cos(a),c=Math.sin(a);return this.x=b*this.x-c*this.y,this.y=c*this.x+b*this.y,this},h.prototype.reset=function(){return this.x=0,this.y=0,this},h.prototype.set=function(a,c){return a===b&&c===b?this:(a.constructor===h&&(c=a.y,a=a.x),this.x=a||0,this.y=c||0,this)},h.prototype.isEqual=function(a){return this.x===a.x&&this.y===a.y},h.prototype.isZero=function(){return 0===this.x&&0===this.y},h.prototype.print=function(a){return(a?a+" :: ":"")+"{ x: "+this.x+", y: "+this.y+"}"},h.prototype.clone=function(){return viva.vector.copy(this)};var i=[],j={initvectorPool:function(){var a,b;for(b=0;16>b;b++)a=i.push(new h)},expandvectorPool:function(){var a,b=200;for(a=i.length;b>a;a++)i.push(new h)},create:function(a,b){return 0===i.length&&j.expandvectorPool(),vectorcnt++,i.pop().set(a,b)},release:function(){for(var a,b=0;b<arguments.length;b++)a=arguments[b],a&&(i.push(a),vectorcnt--,a.reset())},copy:function(a){return 0===i.length&&j.expandvectorPool(),vectorcnt++,i.pop().set(a.x,a.y)}};viva.vector=j,viva.vector.initvectorPool(),a.vectorcnt=0;var k=function(a,b){this.acceleration=viva.vector.create(a,b)};k.prototype.behave=function(a){a.status===q.NORMAL&&a.accelerate(viva.vector.copy(this.acceleration))};var l=function(a){this.boundary={top:a.y,left:a.x,bottom:a.y+a.height,right:a.x+a.width},this.cor=a.cor||1};l.prototype.behave=function(a){var b=this._norm(a),c=a.velocity.clone(),d=-(1+a.cor*this.cor)*c.dot(b),e=b.clone().scale(d);b.isZero()||(a.velocity.add(e),e.magnitude()<20&&a._adjustPosition()),viva.vector.release(c,e)},l.prototype._norm=function(a){var b=this._checkCollisionType(a);return this._norms[b]},l.prototype._checkCollisionType=function(a){var b=a.position.x,c=a.position.y,d=a.radius||a.width/2,e=a.radius||a.height/2;return b+d>=this.boundary.right&&a.velocity.x>0?"right":b-d<=this.boundary.left&&a.velocity.x<0?"left":c+e>=this.boundary.bottom&&a.velocity.y>0?"bottom":c-e<=this.boundary.top&&a.velocity.y<0?"top":"zero"},l.prototype._norms={top:viva.vector.create(0,-1),left:viva.vector.create(-1,0),bottom:viva.vector.create(0,-1),right:viva.vector.create(-1,0),zero:viva.vector.create(0,0)};var m=function(){this.collisions=[]};m.prototype.behave=function(a){this._detect(a),this._collisionResponse()},m.prototype._detect=function(a){var b,c,d=a.world.bodies,e=d.length,f=0;for(f=0;e>f;f++)b=d[f],a!==b&&(c=this._checkCollision(a,b),c&&!this._hasCollision(c)&&this.collisions.push(c))},m.prototype._collisionResponse=function(){var a=this.collisions.length,b=0;for(b=0;a>b;b++)this._collide(this.collisions.pop())},m.prototype._hasCollision=function(a){return this.collisions.some(function(b){return b.bodyA===a.bodyA&&b.bodyB===a.bodyB||b.bodyB===a.bodyA&&b.bodyA===a.bodyB})},m.prototype._checkCollision=function(a,b){var c,d,e=a.position,f=viva.vector.copy(b.position);if("circle"===a.type&&"circle"===b.type&&f.sub(e).magnitude()<=a.radius+b.radius){if(d=viva.vector.copy(f),0===f.magnitude())return;c={bodyA:a,bodyB:b,point:d.scale(a.radius/f.magnitude()).add(e)}}return viva.vector.release(f),c},m.prototype._collide=function(a){var b,c,d,e,f,g,h=a.bodyA,i=a.bodyB,j=a.point,k=viva.vector.copy(h.velocity).sub(i.velocity),l=k.clone(),m=h.mass,n=i.mass,o=viva.vector.copy(j).sub(h.position),p=viva.vector.copy(j).sub(i.position),q=viva.vector.copy(h.position).sub(i.position),r=q.scale(1/q.magnitude()),s=k.projection(r),t=k.sub(s),u=h.cor*i.cor,v=h.cof*i.cof,w=m*h.radius*h.radius/2,x=n*i.radius*i.radius/2,y=viva.vector.copy(o),z=viva.vector.copy(p),A=viva.vector.copy(o),B=viva.vector.copy(p),C=y.scale(y.cross(r)/w),D=z.scale(z.cross(r)/x),E=viva.vector.copy(r),F=-(1+u)*s.magnitude()/(r.dot(r)*(1/m+1/n)+E.dot(C.add(D))),G=viva.vector.copy(r).scale(F),H=viva.vector.copy(r).scale(F),I=o.scale(1/w).cross(G),J=p.scale(1/x).cross(H);l.dot(r)<0&&(h.velocity.sub(G.scale(1/m)),i.velocity.add(H.scale(1/n)),h.angularVelocity-=I,i.angularVelocity+=J,c=t.clone().scale(-1/t.magnitude()),b=t.magnitude()>v*F?-v*F:-t.magnitude(),0===t.magnitude()&&c.reset(),b/=1/m+1/n+r.dot(A.scale(A.cross(c)/w))+r.dot(B.scale(B.cross(c)/x)),d=c.clone().scale(b),e=c.clone().scale(b),f=o.cross(d),g=p.cross(e),h.velocity.sub(d.scale(1/m)),i.velocity.add(e.scale(1/n)),h.angularVelocity-=f,i.angularVelocity+=g),viva.vector.release(k,o,p,q,s,y,z,A,B,E,G,H,j),viva.vector.release(c,d,e),this._adjustBodyPosition(a)},m.prototype._adjustBodyPosition=function(a){var b=a.bodyA,c=a.bodyB,d=viva.vector.copy(b.position),e=viva.vector.copy(c.position),f=e.sub(d),g=b.radius+c.radius-f.magnitude(),h=b.radius/(b.radius+c.radius),i=c.radius/(b.radius+c.radius);b._adjustPosition(),c._adjustPosition(),"circle"===b.type&&"circle"===c.type&&g>0&&(f.normalize().scale(g),b.position.x<c.position.x?(b.position.x-=f.x*h,c.position.x+=f.x*i):(b.position.x+=f.x*h,c.position.x-=f.x*i),b.position.y<c.position.y?(b.position.y-=f.y*h,c.position.y+=f.y*i):(b.position.y+=f.y*h,c.position.y-=f.y*i)),viva.vector.release(d),viva.vector.release(e)};var n={ConstantAcceleration:function(a,b){return new k(a,b)},BoundaryCollision:function(a){return new l(a)},Collision:function(){return new m}};viva.behavior=n;var o=[],p={initPool:function(){var a;for(a=0;16>a;a++)o.push(new r({x:-1e3,y:-1e3}))},expandPool:function(){var a,b=32;for(a=o.length;b>a;a++)o.push(new r({x:-1e3,y:-1e3}))},create:function(a,b){return 0===o.length&&p.expandPool(),b.type=a,o.pop()._set(b)},release:function(a){a._reset(),o.push(a)}},q={NORMAL:1,MOVING:2,FIXED:3,STABLE:4},r=function(a){this.position=viva.vector.create(a.x,a.y),this.velocity=viva.vector.create(),this.acceleration=viva.vector.create(),this.prevPosition=viva.vector.create(),this.angularVelocity=0,this.cof=a.cof||0,this.cor=a.cor||0,this.mass=a.mass||0,this.angle=a.angle||0,this.type=a.type,this.width=a.width,this.height=a.height,this.radius=a.radius,this.world=b,this.color=a.color,this.status=q.NORMAL,this.externalForce=[]};r.prototype.move=function(a){return viva.vector.release(this.prevPosition),this.prevPosition=this.position,this.position=a,this},r.prototype["do"]=function(){var a,b,c=this.world.behaviors,d=0,e=c.length,f=viva.vector.create();if(0===e)return this;for(d=0;e>d;d++)a=c[d],b=a.behave(this),b&&(f.add(b),viva.vector.release(b));return f},r.prototype.applyForce=function(a){return this.externalForce.push(a),this},r.prototype.accelerate=function(a){return this.acceleration.add(a.scale(this.world.ratio)),viva.vector.release(a),this},r.prototype.step=function(a){if(this.status===q.NORMAL){var b,c=viva.vector.create(),d=viva.vector.copy(this.velocity),e=0,f=this.acceleration,g=viva.vector.copy(this.acceleration);if(this.externalForce.length>0)for(e=0;e<this.externalForce.length;e++)b=this.externalForce.pop(),c.add(b),viva.vector.release(b);return this.prevPosition.set(this.position),this.position.add(d.scale(a)).add(g.scale(a*a/2)),this.acceleration=c.scale(1/this.mass).scale(this.world.ratio),this.velocity.add(f.add(this.acceleration).scale(a)),this.angle+=this.angularVelocity*a,viva.vector.release(d),viva.vector.release(f),viva.vector.release(g),this}},r.prototype._adjustPosition=function(){var a=this.position.x,b=this.position.y,c=this.radius||this.width/2,d=this.radius||this.height/2;return 0===this.velocity.magnitude()?this.position:(a+c>this.world.width&&(this.position.x=Math.floor(this.world.width-c)),a-(this.radius||this.width/2)<0&&(this.position.x=Math.ceil(c)),b+d>this.world.height&&(this.position.y=this.world.height-d),this.position.y-d<0&&(this.position.y=d),this)},r.prototype.contains=function(a,b){return"rectangle"===this.type?a<=this.position.x+this.width/2&&a>=this.position.x-this.width/2&&b<=this.position.y+this.height/2&&b>=this.position.y-this.height/2:"circle"===this.type?Math.pow(a-this.position.x,2)+Math.pow(b-this.position.y,2)<=Math.pow(this.radius,2):void 0},r.prototype.setStatus=function(a){return this.status=q[a],this},r.prototype._set=function(a){return this.position.set(a.x,a.y),this.velocity.set(a.vx,a.vy),this.angularVelocity=a.angularVelocity||this.angularVelocity,this.cof=a.cof||this.cof,this.cor=a.cor||this.cor,this.mass=a.mass||this.mass,this.angle=a.angle||this.angle,this.type=a.type,this.width=a.width,this.height=a.height,this.radius=a.radius,this.color=a.color,this},r.prototype._reset=function(){return this.position.reset(),this.velocity.reset(),this.acceleration.reset(),this.prevPosition.reset(),this.angularVelocity=0,this.cof=0,this.cor=0,this.mass=0,this.angle=0,this.type="",this.width=0,this.height=0,this.radius=0,this.color="fff",this},r.prototype.isChanged=function(){return!this.position.isEqual(this.prevPosition)},viva.body=p,viva.body.initPool();var s=function(a){return"object"==typeof a&&1===a.nodeType&&"object"==typeof a.style&&"object"==typeof a.ownerDocument},t=function(c){var d,f=document.body;"string"==typeof c?d=document.getElementById(c):s(c)&&(d=c),d&&"canvas"===d.tagName?this.el=d:d&&(f=d),this.width=this.el&&this.el.width||a.innerWidth,this.height=this.el&&this.el.height||a.innerHeight,this.el===b&&(this.el=document.createElement("canvas"),this.el.width=this.width,this.el.height=this.height,f.appendChild(this.el)),this.el.style.transform="translate3d(0,0,0)",this.el.style["-webkit-transform"]="translate3d(0,0,0)",this.ctx=this.el.getContext("2d"),this.on(e,function(a){a.preventDefault()})};t.prototype.draw=function(a){var b,c=a.length;for(this.ctx.strokeStyle="#000",this.ctx.lineWidth=1,this.ctx.clearRect(0,0,this.width,this.height),b=0;c>b;b++)this._drawBody(a[b])},t.prototype._drawBody=function(a){var b=a.position,c=a.width,d=a.height,e=a.radius,f=Math.round(b.x),g=Math.round(b.y);this.ctx.save(),this.ctx.translate(f,g),this.ctx.rotate(a.angle),this.ctx.beginPath(),"rectangle"===a.type?this.ctx.rect(Math.round(-c/2),Math.round(-d/2),c,d):"circle"===a.type&&this.ctx.arc(0,0,e,0,2*Math.PI,!1),this.ctx.closePath(),this.ctx.fillStyle=a.color,this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(0,-(e||d/2)),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore()},t.prototype._clearBody=function(a){if(this._isInCanvas(a))if("rectangle"===a.type){var b=a.width,c=a.height;this.ctx.clearRect(a.prevPosition.x-b/2*1.1,a.prevPosition.y-c/2*1.1,1.1*b,1.1*c)}else if("circle"===a.type){var d=a.radius;this.ctx.clearRect(a.prevPosition.x-1.1*d,a.prevPosition.y-1.1*d,2.1*d,2.1*d)}},t.prototype._isInCanvas=function(a){return"rectangle"===a.type?this.width>=a.position.x+a.width/2&&this.height>=a.position.y+a.height/2:"circle"===a.type?this.width>=a.position.x+a.radius/2&&this.height>=a.position.y+a.radius/2:void 0},t.prototype.on=function(a,b){this.el.addEventListener(a,b)},t.prototype.off=function(a,b){this.el.removeEventListener(a,b)};var u={canvas:function(a){return new t(a)}};viva.renderer=u;var v=function(){this.bodies=[],this.behaviors=[],this.renderer=b,this.paused=!0,this.ratio=100,this.width=600,this.height=500,this.movingBody=null,this.lastStep=0,this.lastMove=0,this.onMove=this._onMove.bind(this),this.onEnd=this._onEnd.bind(this)};v.prototype.init=function(){},v.prototype.start=function(){this.paused&&(this.lastStep=g(),raf(this._step.bind(this)),this.paused=!1)},v.prototype._step=function(){var a,b,c=g(),d=(c-this.lastStep)/1e3;for(this.lastStep=c,a=0;a<this.behaviors.length;a++)for(var e=0;e<this.bodies.length;e++)b=this.bodies[e],this.behaviors[a].behave(b);for(a=0;a<this.bodies.length;a++)b=this.bodies[a],b.step(d);this.renderer&&this.renderer.draw(this.bodies),this.paused||raf(this._step.bind(this))},v.prototype.add=function(a){a.world=this,this.bodies.push(a)},v.prototype.apply=function(a){this.behaviors.push(a)},v.prototype.setRenderer=function(a){this.renderer=a,this.width=this.renderer.width,this.height=this.renderer.height,this.renderer.on(d,this._onClick.bind(this))},v.prototype.pause=function(){this.paused=!0},v.prototype.resume=function(){this.start()},v.prototype._onClick=function(a){var b,c,d=this.renderer.el.getBoundingClientRect(),g=a.pageX||a.touches[0].pageX-d.left,h=a.pageY||a.touches[0].pageY-d.top;if(!this.paused)for(c=this.bodies.length-1;c>=0;c--)if(b=this.bodies[c],b.contains(g,h))return b.setStatus("MOVING"),b.angularVelocity=0,this.movingBody=b,this.renderer.on(e,this.onMove),void this.renderer.on(f,this.onEnd)},v.prototype._onMove=function(a){var b,d=this.renderer.el.getBoundingClientRect(),e=c?a.touches[0].pageX-d.left:a.pageX,f=c?a.touches[0].pageY-d.top:a.pageY,h=g(),i=h-this.lastMove,j=this.movingBody;return a.preventDefault(),a.stopPropagation(),j&&this._isMovable(j,e,f)?(j.prevPosition.set(e,f),j.move(viva.vector.create(e,f)),b=viva.vector.copy(j.position).sub(j.prevPosition).scale(1e3/i),viva.vector.release(j.velocity),j.velocity=b,void(this.lastMove=h)):void(this.lastMove=0)},v.prototype._isMovable=function(a,b,c){var d=a.radius||a.width/2,e=a.radius||a.height/2,f=this.renderer.el.getBoundingClientRect();return b+d>=f.left+f.width?!1:b-d<=f.left?!1:c+e>=f.top+f.height?!1:c-e<=f.top?!1:!0},v.prototype._onEnd=function(){g()-this.lastMove>300&&this.movingBody.velocity.reset(),this.movingBody.setStatus("NORMAL"),this.movingBody=null,this.renderer.off(e,this.onMove),this.renderer.off(f,this.onEnd)},viva.world=v}(window);